<?php
/**
 * @file
 * Main bootstrap file of the fabric_canvas_view module.
 */
function fabric_canvas_view_init(){
	drupal_add_library('system', 'ui.accordion');
	drupal_add_library('system', 'ui.dialog');
	drupal_add_library('system', 'ui.button');
	drupal_add_library('system', 'ui.slider');
	//drupal_add_library('system', 'effects.blind');
	//drupal_add_library('system', 'farbtastic');
	get_svg();
}
function get_svg(){
	$animals= drupal_get_path("module", "fabric_canvas_view").'/svg/animals';
	
	$scanned_directory = array_diff(scandir($animals), array('..', '.'));

	drupal_add_js(array('canvas_view' => array("svg_items" => array("animals" => $scanned_directory ))), 'setting');
	
	$borders= drupal_get_path("module", "fabric_canvas_view").'/svg/borders';
	
	$scanned_directory = array_diff(scandir($borders), array('..', '.'));

	drupal_add_js(array('canvas_view' => array("svg_items" => array("borders" => $scanned_directory ))), 'setting');
	
}
//get field contents for canvas
function fabric_canvas_view_preprocess_field(&$variables) {
	
	if(isset($variables["element"]["#field_type"])){
		if($variables["element"]["#field_type"] === "text_with_summary"){
			$out = [];
			foreach ($variables["element"]["#items"] as $k => $item){
				$out[] = array("title" => $item["safe_value"], "field_name" => $variables["element"]["#field_name"] , "type" => "text_with_summary");
			}
			drupal_add_js(array('canvas_view' => array("text_items" => $out)), 'setting');
		}
		/* if($variables["element"]["#field_type"] === "entityreference"){
			$out = [];
		foreach ($variables["element"]["#items"] as $k => $item){
		$node_ref =  node_load($item["target_id"]);
		$out[] = array("title" => $node_ref->title, "field_name" => $variables["element"]["#field_name"] ,"type" => "entityreference");

		}
		drupal_add_js(array('canvas_view' =>  array("text_items" => $out)), 'setting');
		} */
	}
	if($variables["element"]["#field_type"] === "image"){
		$out = [];
		foreach ($variables["element"]["#items"] as $k => $item){
			$url = file_create_url($item['uri']);

			$out[] = array("filename" => $item["filename"],"fid" =>  $item["fid"], "src" => $url, "field_name" => $variables["element"]["#field_name"] ,"type" => "image");

		}
		drupal_add_js(array('canvas_view' =>  array("image_items" => $out)), 'setting');

	}

}

/**
 * Implements hook_menu().
 *
 */
function fabric_canvas_view_menu() {
  $menu = array();

  $menu['file_upload_handler'] = array(
    'title' => 'file_upload_handler',
    'page callback' => 'file_upload_handler',
    'access callback' => 'file_upload_handler_access',
    'file' => 'fabric_canvas_view.pages.inc',
     'delivery callback' => '_deliver_page',
    'type' => MENU_CALLBACK,
    'weight' => 0,
  );

  $menu['save_canvas_handler'] = array(
    'title' => 'file_upload_handler',
    'page callback' => 'save_canvas_handler',
    //'page arguments' => array(2),
    'access callback' => 'file_upload_handler_access',
    'file' => 'fabric_canvas_view.pages.inc',
	'delivery callback' => '_deliver_page',
    'type' => MENU_CALLBACK,
    'weight' => 0,
  );

  return $menu;
}

function _deliver_page($page_callback_result) {
// $page_callback_result;
  drupal_exit();
}
/**
 * TODO Autogenerated function.
 */
function file_upload_handler_access() {
  return TRUE;
}
